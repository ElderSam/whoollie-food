<script>
    $(function () {
        $("#btnCreateBoard").click(function (e) {
            e.preventDefault();

            if(!formValidate("formCreateBoard")) {
                return;
            };

            let form = $(`#formCreateBoard`);
            let formData = new FormData(form[0]);

            $.ajax({
                type: "POST",
                url: '/api/boards',
                data: formData,
                contentType: false,
                processData: false,
                success: function(data) {

                    if(JSON.parse(data).error) {
                        swal("Erro!", JSON.parse(data).message, "error");
                    } else {
                        $('#addModal').modal('hide');
                        swal("Tudo certo!", "Mesa adicionada com sucesso!", "success");
                        loadBoards(); 
                        $(`#formCreateBoard`).trigger("reset");
                    }
                    
                },
                error: function(data) {

                    $(`#formCreateBoard`).trigger("reset");
                    console.log(`Erro! Mensagem: ${data}`);
               
                }
            });

        });

        $("#formFilterBoard").on("submit", function(e) {

            e.preventDefault();

            $.post('/api/filter/boards', $(this).serialize(), function (data) {

                $("#viewBoard").html("");

                JSON.parse(data).forEach(element => {

                    $("#viewBoard").append(`
                    <div class="col-lg-3"> 
                        <div class="card shadow mb-4 border-left-${element.isActive == 1 ? "success" : "danger"}"> 
                            <div class="card-header py-3"> 
                                <h6 class="m-0 font-weight-bold text-primary float-left"> ${element.idBoard} </h6>
                           
                            </div>
                            <div class="card-body text-center">
                        
                                <a href="#" class="btn btn-info btn-circle" onclick='loadEditProduct(${element.idBoard});'>
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="#" class="btn btn-danger btn-circle" onclick="removeProduct(${element.idBoard});">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </div>
                    </div>`);

                });

            }).fail(function () {
                console.log("Rota não encontrada!");
            });

        });

        $("#btnCancelCreateBoard").on('click', function() {
            $(`#formCreateBoard`).trigger("reset");
        });

        $("#btnEditBoard").on('click', function(e) {

            e.preventDefault();
            
            if(!formValidate("formEditBoard")) {
                return;
            };

            let form = $('#formEditBoard');
            let formData = new FormData(form[0]);
            let idBoard = $("#formEditBoard").data('id');

            $(form).find(':checkbox:checked, :radio:checked').each(function () {
                formData.append(this.name, $(this).val());
            });

            $.ajax({
                type: "POST",
                url: `/api/board/update/${idBoard}`,
                data: formData,
                contentType: false,
                processData: false,
                success: function(data) {

                    if(JSON.parse(data).error) {
                        swal("Erro!", JSON.parse(data).message, "error");
                    } else {
                        $('#editBoardModal').modal('hide');
                        swal("Tudo certo!", "Mesa editada com sucesso!", "success");
                        loadBoards(); 
                        $(`#formEditBoard`).trigger("reset");
                    }
                    
                },
                error: function(data) {

                    $('#editBoardModal').modal('hide');
                    $(`#formEditBoard`).trigger("reset");
                    console.log(`Erro! Mensagem: ${data}`);
               
                }
            });

        });

        loadBoards();
        loadCategoriesBoards();

    });

    function loadBoards() {

        $("#viewBoard").html("");

        $.getJSON('/api/boards', function (data) {

            data.forEach(element => {

                $("#viewBoard").append(`
                <div class="col-lg-3"> 
                    <div class="card shadow mb-4 border-left-${element.isActive == 1 ? "success" : "danger"}"> 
                        <div class="card-header py-3"> 
                            <h6 class="m-0 font-weight-bold text-primary float-left"> ${element.desName} </h6>
                            <span class="badge badge-success float-right">R$  ${element.vlUnity} </span>
                        </div>
                        <div class="card-body text-center">
                            <img class="fluid-img mb-1" src="/${element.desImagePath}" alt="" style="width: 100px; height: 100px;">
                            <p> ${((element.desNote == "") ? "Produto sem descrição." : element.desNote)} </p>
                            <a href="#" class="btn btn-info btn-circle" onclick='loadEditBoard(${element.idBoard});'>
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="#" class="btn btn-danger btn-circle" onclick='removeBoard(${element.idBoard});'>
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </div>
                </div>`);
            });

        }).fail(function () {
            console.log("Rota não encontrada!");
        });
    }

    function loadEditBoard(idBoard) {

        $.getJSON(`/api/boards/${idBoard}`, function (data) {

            $("#formEditBoard").data("id", idBoard);

            $("#formEditBoard #desName").val(data[0].desName);
            $("#formEditBoard #desNote").val(data[0].desNote);
            $("#formEditBoard #vlUnity").val(data[0].vlUnity);
            $("#formEditBoard #idBoardCategory").val(data[0].idBoardCategory).change();

            if (data[0].isActive == 1) {
                $("#formEditBoard #checkYes").prop("checked",true);
            } else {
                $("#formEditBoard #checkNo").prop("checked",true);
            }

            $("#formEditBoard #desOldImagePath").val(data[0].desImagePath);
            $("#formEditBoard #image").attr("src", data[0].desImagePath);

        }).then(() => {
            $("#editBoardModal").modal();
        }).fail(function () {
            console.log("Rota não encontrada!");
        });

    }

    function removeBoard(idBoard) {

        swal({
            title: "Você tem certeza ?",
            text: "Após deletado você não poderá mais recupera-lo!",
            icon: "warning",
            buttons: true,
            dangerMode: true,
        }).then((willDelete) => {

                if (willDelete) {
                    $.post("/api/board/delete/" + idBoard, function (data) {
                        swal("Deletado com sucesso!", {
                            icon: "success",
                        });
                        loadBoards();
                    }).fail(function () {
                        console.log("Rota não encontrada!");
                    });
                } else {
                    swal("A ação de deletar foi cancelada!");
                }
        });

    }

  

</script>